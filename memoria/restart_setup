#!/bin/bash

USER_HOME="/root"
PUBLIC="/share/MD0_DATA/Public"
BRC="$USER_HOME/.bash_profile"
PROFILE="/etc/profile"

function appendLine {
  echo "Adding \"$1\" to $2"
  echo "$1" >> "$2"
}

setup_comment="##### restart setup appendices:"
appendLine "$setup_comment" "$PROFILE"
appendLine "$setup_comment" "$BRC"

echo -e "\n ======================================"
echo " == env variables"
echo " ======================================"

function appendEnv {
  ENV_KEY="$1"
  ENV_VAL="$2"
  NEW_LINE="export $ENV_KEY=$ENV_VAL"
  if grep -sq "^${NEW_LINE/ /\s}$" "$PROFILE"
  then
    echo "$ENV_KEY is already set."
  else
    appendLine "$NEW_LINE" "$PROFILE"
  fi
}

echo -e "\n ======================================"
echo " == environment variables"
echo " ======================================"

MBIN="$PUBLIC/bin/mbin/memoria"
MBINCOMMON="$PUBLIC/bin/mbin/common"
appendEnv "MBIN" "$MBIN"
appendEnv "PATH" "\$MBIN:$MBINCOMMON:\$PATH"

PATHS="$MBIN/paths"
while IFS= read -r var
do
  # PATHS contains key/value pairs, expanded here to 2 parameters (without quotation marks!)
  appendEnv $var
done < "$PATHS"

echo -e "\n ======================================"
echo " == sym links"
echo " ======================================"

function safelink {
  if [[ ! -e "$1" ]]; then
    echo "Create link to $2"
    ln -s "$2" "$1"
  else
    echo "Link already exists: $1"
  fi
}

safelink "$USER_HOME/media" "$PUBLIC/media"
safelink "$USER_HOME/bin" "$PUBLIC/bin"
safelink "$USER_HOME/data" "$PUBLIC/data"
safelink "$MBIN/set_title" "$MBIN/../haumea/set_title"
safelink "$MBIN/haumea" "$MBIN/../mercury/haumea"

echo -e "\n ======================================"
echo " == .bash_profile appendices"
echo " ======================================"

appendLine "export PS1=\"\\n\\[\\033[1;34m\\]\\u@\\h\\[\\033[00m\\] \\[\\033[0;32m\\]\\w\\[\\033[00m\\]\\n\\$ \"" "$BRC"
appendLine "alias shutdown=\"halt\"" "$BRC"
appendLine "bind 'set mark-symlinked-directories on'" "$BRC"
